<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Title</title>


    <link rel="stylesheet" href="./style.css">

    <style>
        textarea {
            font-size: 16px;
            color: #fff;
            background: rgba(0, 0, 0, .1);
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
            height: 30vh;
            resize: none;
        }

        .login-box {
            width: 50vw;
        }

        @media screen and (max-width: 800px) {
            .login-box {
                width: 90vw;
            }
        }


        #output {
            border: none;
        }

        .upper_btn {
            margin-top: 0 !important;
        }
    </style>
</head>

<body>
    <div id="your-element-id" class="background-image">
        <!-- animated -->
        <div id="large-header">
            <canvas id="demo-canvas"></canvas>
        </div>
        <!-- animated -->
        <div class="login-box">
            <h2 id="title">Chat Room</h2>
            <form>
                <textarea name="myText" id="output" readonly></textarea>
                <br><br><br><br>
                <div class="user-box">
                    <input type="text" name="text" required="" id="content">
                    <label>Send a message</label>
                </div>


                <!-- <a href="#" class=" upper_btn" onclick="chat_type(0)">
          Travel
        </a>
        <a href="#" class="upper_btn" onclick="chat_type(1)">
          Food
        </a>
        <a href="#" class=" upper_btn" onclick="chat_type(2)">
          finance
        </a>
        <a href="#" class=" upper_btn" onclick="chat_type(3)">
          Health
        </a> -->
                <br>
                <a href="#" class="btn">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    Submit
                </a>
            </form>
        </div>
    </div>
</body>

<!-- ============================================== jquery ============================================== -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

<!-- ============================================== sweetAlert ============================================== -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ============================================== animated ============================================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
<!-- self made -->
<script src="./js/animated.js"></script>
<script>
    //  防止圖片閃爍
    $(document).ready(function () {
        var backgroundImage = new Image();
        backgroundImage.src = "./img/backgroundimg.jpg";

        $(backgroundImage).on("load", function () {
            $("#your-element-id").css("filter", "none");
            $("#your-element-id").css("opacity", "1");
        });

        // 歡迎光臨
        let user = JSON.parse(sessionStorage.getItem("user"));
        let message = `Welcome,! Please enter your text to start asking questions.`;
        let index = 0;

        function displayCharacters() {
            if (index < message.length) {
                let substring = message.substring(0, index + 1);
                document.getElementById("output").innerHTML = substring;
                index++;
                setTimeout(displayCharacters, 10); // 0.2秒後再次呼叫函數
            }
        }

        displayCharacters();


        // chat_type = function (type) {
        //   sessionStorage.setItem("chatType", type)
        //   switch (type) {
        //     case 0:
        //       message = `Discussing travel destinations, sightseeing recommendations, travel plans, transportation, and accommodation.`;
        //       index = 0;
        //       displayCharacters();
        //       break;
        //     case 1:
        //       message = `Talking about cuisine, cooking recipes, restaurant recommendations, dietary habits, and specific ingredients.`;
        //       index = 0;
        //       displayCharacters();
        //       break;
        //     case 2:
        //       message = `Welcome to the Finance Chatroom! Here, you can explore and discuss various topics related to finance. Whether you have questions about investing, financial planning, stock markets, or any other financial area, we are here to provide assistance and answers.`;
        //       index = 0;
        //       displayCharacters();
        //       break;
        //     case 3:
        //       message = `Welcome to the Health Chatroom! Here, we delve into various topics related to physical and mental well-being. From healthy lifestyles and fitness to nutrition and mental health, this chatroom provides a platform to discuss and explore the different aspects of leading a balanced and fulfilling life.`;
        //       index = 0;
        //       displayCharacters();
        //       break;
        //   }
        // }
    });

    // 監聽enter
    $("#content").on("keypress", function (event) {
        if (event.which === 13) { // Enter 键的键码是 13
            event.preventDefault(); // 阻止默认的 Enter 键行为，如提交表单
            $(".btn").click();
        }
    });

    $(".btn").on("click", function (e) {
        e.preventDefault();
        document.getElementById("output").innerHTML = "";
        message();
    });


    message = function () {
        let type = sessionStorage.getItem("chatType");
        // let content = "";
        // switch (type) {
        //   case 0:
        //     content = "現在的對話類別是旅行!!" + $("#content").val();
        //     break;
        //   case 1:
        //     content = "現在的對話類別是食物!!" + $("#content").val();
        //     break;
        //   case 2:
        //     content = "現在的對話類別是金融!!" + $("#content").val();
        //     break;
        //   case 3:
        //     content = "現在的對話類別是健康!!" + $("#content").val();
        //     break;
        // }

        let content = $("#content").val();
        console.log(content);

        // 獲得會員資訊，如果等級過低則無法使用
        let user = JSON.parse(sessionStorage.getItem("user"));
        if (user.level > 5) {
            user.level = user.level - 2;
            let userString = JSON.stringify(user);
            sessionStorage.setItem("user", userString);  // 將使用者資訊存入sessionStorage
            // 等級下降
            $.ajax({
                url: "/users",
                method: "PUT",
                data: JSON.stringify(user),
                contentType: "application/json",
                success: function (response) {
                    if (response) {
                        console.log(response);
                    }
                }
            })
            // 傳送訊息
            $.ajax({
                url: "/content",
                method: "POST",
                data: { content: content },
                success: function (response) {
                    $("#content").val("");
                    console.log(response);
                }
            })
        } else {
            Swal.fire({
                position: 'top',
                title: 'Your level is too low',
                timer: 1500,
                showConfirmButton: false,
                background: 'rgba(255, 255, 255, .7)'
            });

        }
    }

    const sseSource = new EventSource(`/sse`);
    sseSource.addEventListener("message", function (event) {
        console.log(event);

        if (event.data !== null) {
            let processedData = event.data.replace(/\\n/g, '\n');
            processedData = processedData.replace("\\s", " ");
            // let value = event.data.replace(/\\n/g, "\n");
            document.getElementById("output").innerHTML += processedData;
            // console.log(value)
        }
    });


</script>

</html>